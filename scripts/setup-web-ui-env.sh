#!/bin/bash
# Setup web-ui .env.local from deployment outputs
set -e

echo "ðŸš€ Setting up Web UI environment..."

# Get deployment ID
DEPLOYMENT_ID=$(node -p "require('./deployment-config.json').deploymentId" 2>/dev/null || echo "default")
STACK_NAME="AgentStack-${DEPLOYMENT_ID}"

# Parse flags
FORCE=false
for arg in "$@"; do
    case $arg in
        --force) FORCE=true ;;
    esac
done

# Check if .env.local exists
if [[ -f "web-ui/.env.local" && "$FORCE" == "false" ]]; then
    echo "âš ï¸  web-ui/.env.local already exists"
    echo "   Run with --force to regenerate"
    exit 0
fi

# Set region
REGION=${AWS_REGION:-us-west-2}

# Get CDK outputs from CloudFormation
echo "ðŸ“Š Querying ${STACK_NAME}..."
CDK_OUTPUTS=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --region "$REGION" --query "Stacks[0].Outputs" --output json 2>/dev/null) || {
    echo "âŒ Could not query ${STACK_NAME}. Deploy agent stack first."
    exit 1
}

# Parse CDK outputs
RUNTIME_ARN=$(echo "$CDK_OUTPUTS" | jq -r '.[] | select(.OutputKey=="RuntimeArn") | .OutputValue // empty')
RUNTIME_ID=$(echo "$CDK_OUTPUTS" | jq -r '.[] | select(.OutputKey=="RuntimeId") | .OutputValue // empty')
MEMORY_ID=$(echo "$CDK_OUTPUTS" | jq -r '.[] | select(.OutputKey=="MemoryId") | .OutputValue // empty')
GATEWAY_URL=$(echo "$CDK_OUTPUTS" | jq -r '.[] | select(.OutputKey=="GatewayUrl") | .OutputValue // empty')
GATEWAY_ID=$(echo "$CDK_OUTPUTS" | jq -r '.[] | select(.OutputKey=="GatewayId") | .OutputValue // empty')
VOICE_WS_URL=$(echo "$CDK_OUTPUTS" | jq -r '.[] | select(.OutputKey=="VoiceWebSocketUrl") | .OutputValue // empty')
COST_API_URL=$(echo "$CDK_OUTPUTS" | jq -r '.[] | select(.OutputKey=="CostMonitorApiUrl") | .OutputValue // empty')
DOCUMENTS_BUCKET=$(echo "$CDK_OUTPUTS" | jq -r '.[] | select(.OutputKey=="DocumentsBucketName") | .OutputValue // empty')

# Read Amplify outputs
if [[ ! -f "amplify_outputs.json" ]]; then
    echo "âŒ amplify_outputs.json not found. Deploy Amplify first."
    exit 1
fi

USER_POOL_ID=$(jq -r '.auth.user_pool_id // empty' amplify_outputs.json)
USER_POOL_CLIENT_ID=$(jq -r '.auth.user_pool_client_id // empty' amplify_outputs.json)

# Validate required values
if [[ -z "$RUNTIME_ARN" || -z "$USER_POOL_ID" || -z "$USER_POOL_CLIENT_ID" ]]; then
    echo "âŒ Missing required values. Ensure both stacks are deployed."
    echo "   RUNTIME_ARN: $RUNTIME_ARN"
    echo "   USER_POOL_ID: $USER_POOL_ID"
    exit 1
fi

# Generate .env.local
cat > web-ui/.env.local << EOF
# Auto-generated by setup-web-ui-env.sh
# Generated at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")

# AWS Configuration
VITE_AWS_REGION=${REGION}

# Cognito Configuration
VITE_USER_POOL_ID=${USER_POOL_ID}
VITE_USER_POOL_CLIENT_ID=${USER_POOL_CLIENT_ID}

# Agent Runtime Configuration
VITE_AGENT_RUNTIME_ARN=${RUNTIME_ARN}
VITE_AGENT_RUNTIME_ID=${RUNTIME_ID}
VITE_AGENT_ENDPOINT_NAME=DEFAULT

# Memory Configuration
VITE_MEMORY_ID=${MEMORY_ID}

# Gateway Configuration
VITE_GATEWAY_URL=${GATEWAY_URL}
VITE_GATEWAY_ID=${GATEWAY_ID}

# Voice (Nova Sonic) Configuration
VITE_VOICE_WS_URL=${VOICE_WS_URL}

# Cost Monitor API
VITE_COST_API_URL=${COST_API_URL}

# Documents Bucket
VITE_DOCUMENTS_BUCKET=${DOCUMENTS_BUCKET}
EOF

echo "âœ… Created web-ui/.env.local"
echo ""
echo "Next: cd web-ui && npm run dev"
